<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elyx Member Journey | Rohan Patel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #e2e8f0; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .highlight-decision { transition: all 0.3s ease; box-shadow: 0 0 15px 2px rgba(79, 70, 229, 0.6); border: 1px solid rgba(79, 70, 229, 0.8); }
    .highlight-reason { transition: all 0.3s ease; box-shadow: 0 0 15px 2px rgba(5, 150, 105, 0.6); border: 1px solid rgba(5, 150, 105, 0.8); }
    .decision-bubble { cursor: pointer; border: 1px solid #6366f1; transition: background-color 0.2s ease-in-out; }
    .decision-bubble:hover { background-color: #4f46e5; color: white; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .page-content { animation: fadeIn 0.5s ease-out forwards; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
    .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem; border: 1px solid #d1d5db; width: 80%; max-width: 600px; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); }
    .modal-close { color: #9ca3af; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-close:hover, .modal-close:focus { color: #111827; text-decoration: none; }
    #chat-agent-window { display: none; position: absolute; bottom: 80px; right: 1.5rem; width: 350px; height: 450px; background-color: #ffffff; border: 1px solid #d1d5db; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); transition: all 0.3s ease; }
    .nav-btn { padding: 0.75rem 1rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #e2e8f0; font-weight: 500; }
    .nav-btn.active { border-bottom-color: #ffffff; color: #ffffff; font-weight: 600; }
  </style>
</head>
<body class="antialiased">
  <div class="flex flex-col h-screen">
    <!-- HEADER -->
    <header class="bg-slate-800 p-4 shadow-md z-10">
      <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-white">Elyx Member Dashboard</h1>
            <p class="text-sm text-slate-300">Rohan Patel</p>
          </div>
          <div id="api-status" class="flex items-center space-x-2">
            <span class="text-sm font-medium text-slate-300">API Status:</span>
            <div id="api-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
          </div>
        </div>
        <nav class="mt-4">
          <div class="flex space-x-2">
            <button class="nav-btn active" data-page="home">Home</button>
            <button class="nav-btn" data-page="journey">Journey</button>
            <button class="nav-btn" data-page="status">Health Status</button>
            <button class="nav-btn" data-page="profile">Profile</button>
          </div>
        </nav>
      </div>
    </header>

    <!-- MAIN PAGES -->
    <div class="flex-1 overflow-y-auto">
      <!-- HOME -->
      <main id="page-home" class="page-content p-8">
        <h1 class="text-4xl font-bold text-slate-900">Welcome, Rohan!</h1>
        <p class="text-lg text-slate-600 mt-1">This is your personalized health dashboard.</p>
        <div id="home-container" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
      </main>

      <!-- JOURNEY -->
      <main id="page-journey" class="page-content hidden h-full flex">
        <aside class="w-1/3 lg:w-1/4 bg-white border-r border-slate-200 overflow-y-auto p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Journey Timeline</h2>
          <div id="timeline-container" class="relative border-l-2 border-slate-300 pl-6 space-y-8"></div>
        </aside>
        <section class="flex-1 flex flex-col bg-slate-100 relative">
          <div class="border-b border-slate-200 p-4 space-y-3">
            <h2 id="conversation-title" class="text-lg font-semibold text-gray-900">Full Conversation</h2>
            <div id="filter-container" class="flex flex-wrap gap-2"></div>
          </div>
          <div id="conversation-container" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
          <div class="p-4 border-t border-slate-200 bg-white/50">
            <button id="chat-agent-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
              Ask Elyx AI
            </button>
          </div>
          <!-- Chat window -->
          <div id="chat-agent-window" class="flex flex-col">
            <div class="p-3 bg-gray-200 rounded-t-lg flex justify-between items-center">
              <h3 class="text-md font-semibold text-gray-900">Elyx AI Assistant</h3>
              <button id="chat-close-btn" class="text-gray-500 hover:text-gray-900 text-2xl font-bold">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto space-y-3 bg-white">
              <div class="p-2 bg-indigo-100 rounded-lg text-sm text-indigo-800">Hi! Ask me why a decision was made.</div>
            </div>
            <div class="p-3 border-t border-gray-200">
              <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ask a question...">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 rounded-lg">Send</button>
              </form>
            </div>
          </div>
        </section>
        <aside class="w-1/3 lg:w-1/4 bg-white border-l border-slate-200 overflow-y-auto p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Internal Metrics</h2>
          <div id="metrics-container" class="space-y-4"></div>
        </aside>
      </main>

      <!-- STATUS -->
      <main id="page-status" class="page-content hidden h-full p-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">Health Status Dashboard</h2>
        <div id="health-status-container" class="space-y-8"></div>
      </main>

      <!-- PROFILE -->
      <main id="page-profile" class="page-content hidden h-full p-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">Member Profile</h2>
        <div id="profile-container" class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <p><b>Name:</b> Rohan Patel</p>
            <p><b>DOB:</b> 12 March 1979 (46 yrs)</p>
            <p><b>Residence:</b> Singapore</p>
            <p><b>Occupation:</b> Regional Head of Sales, FinTech</p>
            <p><b>Travel:</b> Frequent to UK, US, South Korea, Jakarta</p>
          </div>
          <div>
            <p><b>Goals:</b></p>
            <ul class="list-disc list-inside">
              <li>Reduce risk of heart disease (by Dec 2026)</li>
              <li>Enhance cognitive performance (by Jun 2026)</li>
              <li>Annual full-body screenings (start Nov 2025)</li>
            </ul>
            <p><b>Motivation:</b> Family history, career performance, kids</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="analysis-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modal-close-btn">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const API_BASE_URL = "https://elyx-journey-api.onrender.com";

    async function fetchData(endpoint, options = {}) {
      try {
        const res = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error(`Failed to fetch from ${endpoint}:`, err);
        return null;
      }
    }

    async function handleTimelineClick(monthName) {
      const data = await fetchData(`/analysis/${encodeURIComponent(monthName)}`);
      if (!data) { alert("No analysis available for " + monthName); return; }

      document.getElementById("modal-body").innerHTML = `
        <h3 class="text-lg font-bold">${data.month_name}</h3>
        <p><b>Primary Trigger:</b> ${data.primary_goal_trigger}</p>
        <p><b>Friction Points:</b> ${data.friction_points.join(", ") || "None"}</p>
        <p><b>Outcome:</b> ${data.final_outcome}</p>
        <p><b>Persona:</b> Before - ${data.persona_analysis.before}, After - ${data.persona_analysis.after}</p>
      `;
      document.getElementById("analysis-modal").style.display = "block";
    }

    // CHAT
    document.getElementById("chat-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("chat-input");
      const question = input.value.trim();
      if (!question) return;

      const chatMessages = document.getElementById("chat-messages");
      chatMessages.innerHTML += `<div class="p-2 bg-gray-200 rounded-lg">${question}</div>`;
      input.value = "";

      const data = await fetchData("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: question })
      });

      if (data?.response) {
        chatMessages.innerHTML += `<div class="p-2 bg-indigo-100 rounded-lg">${data.response}</div>`;
      } else {
        chatMessages.innerHTML += `<div class="p-2 bg-red-100 rounded-lg">Error: Unable to get response</div>`;
      }
    });

    // MODAL CLOSE
    document.getElementById("modal-close-btn").onclick = () => {
      document.getElementById("analysis-modal").style.display = "none";
    };
  </script>
</body>
</html>
